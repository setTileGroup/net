var mapbg = "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";

var pointerimg = "iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAABHNCSVQICAgIfAhkiAAAAQlJREFUSIntlTFSxTAMRFd2KH7HzL8MnAEKKgoKDsE9OAAHYDgInAgaxpG0NCmYiRNkk9KvjLW7VhTHQCeq+kLyoVefeoU550sAd736btyd7s5efVfHqvouIhARkPzoDW+C5IlrTq0+PR3fVp7dtJpIq4Dkaq5mhmmamryaiklmALqxfCEiW2srWl/1287aa4tRU8fuTpG6xN2Rcw77hTue5/lrKxQAUkoopXxG/aKh15UjVKWUchXxDHWcUgr/GnPO95G60ExqR2jXdG8mC92XxH8JBbd0TPL7sGARCc1tqX2M1v4JybOZmbtvfs3LNakkz4cF/9rAk6quQs2MZvZ8eOBgMBgMAOAHekbRuBn6GT8AAAAASUVORK5CYII=";

var ctx = com.mojang.minecraftpe.MainActivity.currentMainActivity.get();
var dm = ctx.getResources().getDisplayMetrics();
var dp = dm.density, screenH = dm.heightPixels, screenW = dm.widthPixels;

if(screenH>screenW)
{
	var tteemmpp = screenH;
	screenH = screenW;
	screenW = tteemmpp;
}

var worldsdir = "/sdcard/games/com.mojang/minecraftWorlds/",locationfile;

var r=12, pix=5, alpha=75, jump=3, pointertime=1, isPriority=false, isDefaultLocation=true, mapx=0, mapy=0;
var isDraw=false, isExit=true, isLock=false, drawMode=0, locationstate=0, isMapShowing=false;

var currentlocation,currentWolrdName,currentWolrdDir,locations=new Array();

var bmp, canvas, p = new android.graphics.Paint(), bitmaptemp, lbmp, lcanvas, lbmpp = new android.graphics.Paint();


var menupopll = newLinearLayout(-1,-1,1);

var bt_radar = newButton(-1,-2,"雷达模式");
bt_radar.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		if(drawMode==0)
		{
			drawMode=1;
			bt_radar.setText("标准模式");
		}
		else
		{
			drawMode=0;
			bt_radar.setText("雷达模式");
		}
		menupop.dismiss();
		showMap();
	}
});

var bt_setlocation = newButton(-1,-2,"标记管理");
bt_setlocation.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		buildLocationDialog().show();
		menupop.dismiss();
		showMap();
	}
});

var bt_largemap = newButton(-1,-2,"大地图浏览");
bt_largemap.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		menupop.dismiss();
		showMap();
		buildItemsDialog("选择扫描直径",["64","128","160","192","256"],new android.content.DialogInterface.OnClickListener()
		{
			onClick:function(di,p)
			{
				closeLargeMap();
				switch(p)
				{
					case 0:
						buildLargeMap(64);
						break;
					case 1:
						buildLargeMap(128);
						break;
					case 2:
						buildLargeMap(160);
						break;
					case 3:
						buildLargeMap(192);
						break;
					case 4:
						buildLargeMap(256);
						break;
				}
			}
		}).show();
	}
});

var bt_set = newButton(-1,-2,"设置");
bt_set.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		buildSettingDialog().show();
		menupop.dismiss();
		showMap();
	}
});

var bt_exit = newButton(-1,-2,"退出");
bt_exit.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		leaveGame();
	}
});

var bt_back = newButton(-1,-2,"取消");
bt_back.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		menupop.dismiss();
		showMap();
	}
});

menupopll.addView(bt_radar);
menupopll.addView(bt_setlocation);
menupopll.addView(bt_largemap);
menupopll.addView(bt_set);
menupopll.addView(bt_exit);
menupopll.addView(bt_back);

var menupop = new android.widget.PopupWindow(menupopll,-2,-2)


var mapll = newLinearLayout(-1,-1,1);

var mapfl = new android.widget.FrameLayout(ctx);
mapfl.setLayoutParams(new android.widget.FrameLayout.LayoutParams(100*dp,100*dp));

var mapiv = newImageView(-1,-1,android.widget.ImageView.ScaleType.FIT_XY);
mapiv.setImageBitmap(decodeBase64(mapbg));
mapiv.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		ctx.runOnUiThread(new java.lang.Runnable()
		{
			run:function()
			{
				dismissMap();
				showMenu();
			}
		});
	}
});

var pointerrl = new android.widget.RelativeLayout(ctx);
pointerrl.setLayoutParams(new android.widget.RelativeLayout.LayoutParams(-1,-1));
pointerrl.setGravity(17);

var pointeriv = newImageView(3*pix*dp,3*pix*dp,android.widget.ImageView.ScaleType.FIT_XY);
pointeriv.setImageBitmap(decodeBase64(pointerimg));

pointerrl.addView(pointeriv);

var maptv = newTextView(10,-1,-1,-2);
maptv.setGravity(17);

mapfl.addView(mapiv);
mapfl.addView(pointerrl);

mapll.addView(mapfl);
mapll.addView(maptv);

var map = new android.widget.PopupWindow(mapll,-2,-2);


var largemapll = newLinearLayout(-1,-1,1);
largemapll.setGravity(17);
largemapll.setBackgroundColor(0x60000000);

var largemapiv = newImageView(-1,-1,android.widget.ImageView.ScaleType.FIT_CENTER);
largemapiv.setLayoutParams(new android.widget.LinearLayout.LayoutParams(-1,-1,1));
largemapiv.setVisibility(8);

var largemaptv = newTextView(20,-1,-2,-2);

var largemapbtmll = newLinearLayout(-1,-2,0);
largemapbtmll.setGravity(16);

var bt_largemapsave = newButton(-2,-2,"保存");
bt_largemapsave.setEnabled(false);
bt_largemapsave.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		var pngfilestr = worldsdir+Level.getWorldDir()+"/TempMap-";
		var pngfile = new java.io.File(pngfilestr+"1.png");
		for(var i = 1;pngfile.exists();i++)
		{
			pngfile = new java.io.File(pngfilestr+i+".png");
		}
		buildAlertDialog("保存地图预览","保存到"+pngfile.toString(), new java.lang.Runnable()
		{
			run:function()
			{
				try
				{
					pngfile.getParentFile().mkdirs();
					var fos = new java.io.FileOutputStream(new java.io.File(pngfile));
					lbmp.compress(android.graphics.Bitmap.CompressFormat.PNG, 90, fos);
					print("成功保存："+pngfile);
				}
				catch(e)
				{
					print(e)
				}
			}
		}).show();
	}
});

var largemaploc = newTextView(11,-1,-2,-2);
largemaploc.setGravity(17);
largemaploc.setBackgroundColor(0x60000000);

var bt_largemapclose = newButton(-2,-2,"关闭");
bt_largemapclose.setEnabled(false);
bt_largemapclose.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		closeLargeMap();
	}
});

var bt_largemaphide = newButton(-1,-2,"最小化");
bt_largemaphide.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(v)
	{
		hideLargeMap();
	}
});

largemapbtmll.addView(bt_largemapsave);
largemapbtmll.addView(largemaploc);
largemapbtmll.addView(bt_largemapclose);
largemapbtmll.addView(bt_largemaphide);

largemapll.addView(largemaptv);
largemapll.addView(largemapiv);
largemapll.addView(largemapbtmll);

var largemap = new android.widget.PopupWindow(largemapll,screenH,screenH);


var locationll = newLinearLayout(-2,-2,1);
locationll.setGravity(1);

var locationcolortv = newTextView(20,RGB(100,100,255),-1,-2);
locationcolortv.setText("♦");
locationcolortv.setGravity(17);

var locationtv = newTextView(14,-1,-1,-2);
locationtv.setBackgroundColor(0x50000000);

locationll.addView(locationcolortv);
locationll.addView(locationtv);

var location = new android.widget.PopupWindow(locationll,-2,-2);
location.setTouchable(false);


var bt_largemaprestore = newButton(-2,-2,"显示缓存地图");
bt_largemaprestore.setOnClickListener(new android.view.View.OnClickListener()
{
	onClick:function(view)
	{
		showLargeMap();
	}
});

var largemaprestore = new android.widget.PopupWindow(bt_largemaprestore,-2,-2);


function newButton(w,h,text)
{
	var button = new android.widget.Button(ctx);
	button.setLayoutParams(new android.widget.LinearLayout.LayoutParams(w,h));
	button.setText(text);
	return button;
}

function newTextView(size,color,w,h)
{
	var textview = new android.widget.TextView(ctx);
	textview.setTextSize(size);
	textview.setTextColor(color);
	textview.setLayoutParams(new android.widget.LinearLayout.LayoutParams(w,h));
	return textview;
}

function newImageView(w,h,scaletype)
{
	var imageview = new android.widget.ImageView(ctx);
	imageview.setLayoutParams(new android.widget.LinearLayout.LayoutParams(w,h));
	imageview.setScaleType(scaletype);
	return imageview;
}

function newLinearLayout(w,h,orientation)
{
	var linearlayout = new android.widget.LinearLayout(ctx);
	linearlayout.setOrientation(orientation);
	linearlayout.setLayoutParams(new android.widget.LinearLayout.LayoutParams(w,h));
	return linearlayout;
}

function buildAlertDialog(title,msg,runnable)
{
	return new android.app.AlertDialog.Builder(ctx).setTitle(title).setMessage(msg).setNegativeButton("取消",null).setPositiveButton("确认",new android.content.DialogInterface.OnClickListener()
	{
		onClick:function(di,p)
		{
			runnable.run();
		}
	});
}

function buildItemsDialog(title,items,clicklistener)
{
	return new android.app.AlertDialog.Builder(ctx).setTitle(title).setItems(items,clicklistener).setNegativeButton("取消",null);
}

function buildSettingDialog()
{
/*	var dismisslistener = new android.content.DialogInterface.OnDismissListener()
	{
		onDismiss:function(di)
		{
			showMap();
		}
	}*/
	var	setdialog = buildItemsDialog("设置",["扫描半径："+readPrf("r",12),"扫描跳跃间隔："+readPrf("jump",3),"坐标刷新频率："+readPrf("pointertime",1)*50+"ms","透明度："+readPrf("alpha",75)+"%","线程优先级："+readPrf("priority","标准")],new android.content.DialogInterface.OnClickListener()
	{
		onClick:function(di,p)
		{
			switch(p)
			{
				case 0:
					buildItemsDialog("扫描半径",["8","10","12","15","18","20(不推荐)"],new android.content.DialogInterface.OnClickListener()
					{
						onClick:function(di,p)
						{
							var tempr=12;
							switch(p)
							{
								case 0:
									tempr=8;
									break;
								case 1:
									tempr=10;
									break;
								case 2:
									tempr=12;
									break;
								case 3:
									tempr=15;
									break;
								case 4:
									tempr=18;
									break;
								case 5:
									tempr=20;
									break;
							}
							r=tempr;
							putPrf("r",tempr);
						}
					}).show();
					break;
				case 1:
					buildItemsDialog("扫描跳跃间隔",["暴力扫描(不推荐)","2","3(推荐)","4","5(不推荐，错误率高)"],new android.content.DialogInterface.OnClickListener()
					{
						onClick:function(di,p)
						{
							var tempjump=3;	
							switch(p)
							{
								case 0:
									tempjump=1;
									break;
								case 1:
									tempjump=2;
									break;
								case 2:
									tempjump=3;			
									break;
								case 3:
									tempjump=4;
									break;
								case 4:
									tempjump=5;
									break;
							}
							jump=tempjump;
							putPrf("jump",tempjump);
						}
					}).show();
					break;
				case 2:
					buildItemsDialog("坐标刷新频率",["50ms","100ms","200ms","300ms"],new android.content.DialogInterface.OnClickListener()
					{
						onClick:function(di,p)
						{
							var temppt=1;
							switch(p)
							{
								case 0:
									temppt=1;
									break;
								case 1:
									temppt=2;
									break;
								case 2:
									temppt=4;
									break;
								case 3:
									temppt=6;
									break;
							}
							pointertime=temppt;
							putPrf("pointertime",temppt);
							ticktime=0;
						}
					}).show();
					break;
				case 3:
					buildItemsDialog("透明度",["50%","75%","90%","不透明"],new android.content.DialogInterface.OnClickListener()
					{
						onClick:function(di,p)
						{
							var tempa=3;	
							switch(p)
							{
								case 0:
									tempa=50;
									break;
								case 1:
									tempa=75;
									break;
								case 2:
									tempa=90;
									break;
								case 3:
									tempa=100;
									break;
							}
							alpha=tempa;
							putPrf("alpha",tempa);
							mapiv.setAlpha(tempa/100);
							largemapiv.setAlpha(tempa/100);
						}
					}).show();
					break;
				case 4:
					buildItemsDialog("线程优先级",["标准","高"],new android.content.DialogInterface.OnClickListener()
					{
						onClick:function(di,p)
						{
							if(p==1)
							{
								putPrf("priority","高");
								isPriority=true;
							}
							else
							{
								putPrf("priority","标准");
								isPriority=false;
							}
							print("重新进入游戏生效");
						}
					}).show();
					break;
			}
		}
	});
	return setdialog;
}

function buildLocationDialog()
{
	var locationliststr = getLocationStringList();
	
	var locdialog = buildItemsDialog("选择显示标记",locationliststr,new android.content.DialogInterface.OnClickListener()
	{
		onClick:function(di,p)
		{
			if(p>0)
			{
				var l=locations[p-1];
				showLocation(l.name,l.x,l.y,l.z);
			}
			else
			{
				hideLocation();
			}
		}
	}).setPositiveButton("标记当前坐标",new android.content.DialogInterface.OnClickListener()
	{
		onClick:function(di,p)
		{
			var nameet = new android.widget.EditText(ctx);
			nameet.setWidth(-1);
			buildAlertDialog("标记当前坐标","名称：",new java.lang.Runnable()
			{
				run:function()
				{
					addLocationData(nameet.getText().toString(),Player.getX(),Player.getY(),Player.getZ());
					saveLocationData();
					var l=locations[0];
					showLocation(l.name,l.x,l.y,l.z);
				}
			}).setView(nameet).show();
		}
	}).setNeutralButton("删除",new android.content.DialogInterface.OnClickListener()
	{
		onClick:function(di,p)
		{
			buildDeleteLocationDialog().show();
		}
	});
	return locdialog
}

function buildDeleteLocationDialog()
{
	var loclist = getLocationStringList();
	loclist[0] = "删除全部";
	return buildItemsDialog("删除坐标标记", loclist, new android.content.DialogInterface.OnClickListener()
	{
		onClick:function(di,p)
		{
			if(p>0)
			{
				locations.splice(p-1,1);
				saveLocationData();
			}
			else
			{
				buildAlertDialog("删除全部坐标标记","确认要删除该存档的所有坐标标记？",new java.lang.Runnable()
				{
					run:function()
					{
						locationfile.delete();
						locations = new Array();
						hideLocation();
					}
				}).show();
			}
		}
	});
}

function decodeBase64(code)
{
	return android.graphics.BitmapFactory.decodeByteArray(android.util.Base64.decode(code,0),0,android.util.Base64.decode(code,0).length);
}

function formatNumber(d,s)
{
	return new java.text.DecimalFormat(s).format(d);
}

function RGB(red,green,blue)
{
	return android.graphics.Color.rgb(red,green,blue);
}

function getLocationData()
{
	locations = new Array();
	try
	{
		var br = new java.io.BufferedReader(new java.io.FileReader(locationfile));
		var tempstr = br.readLine().split("#");
		for(var i = 0;i<tempstr.length;i++)
		{
			var str = tempstr[i].split("!");
			if(str.length==4)
			{
				locations.unshift(new locationData(str[0],str[1],str[2],str[3]));
			}
		}
	}
	catch(e)	
	{
		print(e);
	}
}

function addLocationData(name,x,y,z)
{
	locations.unshift(new locationData(name,x,y,z));
}

function saveLocationData()
{
	var savestr = new java.lang.StringBuffer();
	for(var i = 0;i<locations.length;i++)
	{
		var l = locations[i];
		savestr.append(l.name+"!"+l.x+"!"+l.y+"!"+l.z+"#");
	}
	var str=savestr.toString();
	try
	{
		var fos = new java.io.FileOutputStream(locationfile);
		fos.write(str.getBytes());
		fos.close();
	}
	catch(e)
	{
		print(e);
	}
}

function getLocationStringList()
{
	var lsl = new Array();
	lsl.push("关闭显示");
	if(locationfile.exists()&&locationfile.length()>0)
	{
		getLocationData();
		for(var i = 0;i<locations.length;i++)
		{
			var l=locations[i];
			lsl.push(new java.lang.String(l.name+" X:"+l.x+",Y:"+l.y+",Z:"+l.z));
		}
	}
	return lsl
}

function readPrf(key,def)
{
	var readtemp = ModPE.readData(key);
	if(readtemp.equals(""))
	{
		return def;
	}
	else
	{
		return readtemp;
	}
}

function putPrf(key,value)
{
	ModPE.saveData(key,value);
}

function initData()
{
	r = parseInt(readPrf("r",12));
	jump = parseInt(readPrf("jump",3));
	pointertime = parseInt(readPrf("pointertime",1));
	isPriority = readPrf("priority","标准").equals("高");
	isDefaultLocation = readPrf("defxy",true);
	mapx = readPrf("x",0);
	mapy = readPrf("y",0);
	alpha = parseInt(readPrf("alpha",75)/100);
	isLock = readPrf("lock",false);
}

function locationData(locname,locx,locy,locz)
{
	this.name=locname;
	this.x=parseInt(locx);
	this.y=parseInt(locy);
	this.z=parseInt(locz);
}

function newLevel()
{
	isExit = false;
	ctx.runOnUiThread(new java.lang.Runnable()
	{
		run:function()
		{
			initData();
			new android.os.Handler().postDelayed(new java.lang.Runnable()
			{
				run:function()
				{
					currentWolrdName = Level.getWorldName();
					currentWolrdDir = Level.getWorldDir();
					locationfile = new java.io.File(worldsdir+currentWolrdDir,currentWolrdName+".location");
					if(!isExit)
					{
						drawMode=0;
						isDraw=true;
						showMap();
						startDrawMap();
					}
				}
			},2000);
		}
	});
}

function procCmd(string)
{
	var splits = string.split(" ");
	if(splits[0].equals("unlock"))
	{
		ctx.runOnUiThread(new java.lang.Runnable()
		{
			run:function()
			{
				lockMap(false);
			}
		});
	}
	else if(splits[0].equals("lock"))
	{
		ctx.runOnUiThread(new java.lang.Runnable()
		{
			run:function()
			{
				lockMap(true);
			}
		});
	}
	else if(splits[0].equals("drawmap"))
	{
		ctx.runOnUiThread(new java.lang.Runnable()
		{
			run:function()
			{
				showLargeMap(splits[1]);
			}
		});
	}
	else if(splits[0].equals("restart"))
	{
		newLevel();
	}
}

var ticktime = 0;
var yawdeg,pitchdeg,lllx,llly,lllz,llx,lly,llz,loxz,loxyz,slox,sloy,movex,movey;
var locationtextsize = 14;

function modTick()
{
	if(ticktime==pointertime)
	{
		ticktime=0;
		
		ctx.runOnUiThread(new java.lang.Runnable()
		{
			run:function()
			{
				yawdeg = Entity.getYaw(Player.getEntity())%360;
				pointeriv.setRotation(yawdeg+180);
				maptv.setText(getLocationString());
				switch(locationstate)
				{
					case 0:
						location.dismiss();
						break;
					case 1:
						pitchdeg = Entity.getPitch(Player.getEntity())%360;
						llx=lllx-Player.getX(),lly=llly-Player.getY(),llz=lllz-Player.getZ();
						loxz = Math.sqrt(llx*llx+llz*llz), loxyz=Math.sqrt(loxz*loxz+lly*lly);
						lyawdeg = (Math.acos(llx/loxz)/Math.PI)*180*(llz>0?1:-1), lpitchdeg = (Math.asin(lly/loxyz)/Math.PI)*180;
						slox=(lyawdeg-yawdeg)%360-90,sloy=-pitchdeg-lpitchdeg;
						movex=Math.sin(slox/180*Math.PI)*screenW*0.4,movey=Math.sin(sloy/180*Math.PI)*screenH*0.4;
						if(((slox<85&&slox>-85)||(slox<-275))&&sloy<40&&sloy>-40)
						{
							
							if(!location.isShowing())
							{
								location.showAtLocation(ctx.getWindow().getDecorView(), 17, 0,0);
							}
							location.update(movex,movey,-2,-2);
						}
						else
						{
							location.dismiss();
						}
						if(locationtextsize!=14&&loxyz<5)
						{
							locationtv.setTextSize(14);
							locationtextsize=14;
							locationcolortv.setTextSize(20);
						}
						else if(locationtextsize!=13&&loxyz>5&&loxyz<15)
						{
							locationtv.setTextSize(13);
							locationtextsize=13;
							locationcolortv.setTextSize(18);
						}
						else if(locationtextsize!=12&&loxyz>15&&loxyz<30)
						{
							locationtv.setTextSize(12);
							locationtextsize=12;
							locationcolortv.setTextSize(16);
						}
						else if(locationtextsize!=11&&loxyz>30&&loxyz<50)
						{
							locationtv.setTextSize(11);
							locationtextsize=11;
							locationcolortv.setTextSize(14);
						}
						else if(locationtextsize!=10&&loxyz>50)
						{
							locationtv.setTextSize(10);
							locationtextsize=10;
							locationcolortv.setTextSize(12);
						}
						locationtv.setText(currentlocation+" "+formatNumber(loxyz,"#0.0")+"M");
						break;
				}
			}
		});
	}
	ticktime++;
}

function leaveGame()
{
	isDraw=false;
	isExit=true;
	ctx.runOnUiThread(new java.lang.Runnable()
	{
		run:function()
		{
			closeLargeMap();
			dismissMap();
			hideLocation();
			menupop.dismiss();
			largemaprestore.dismiss();
		}
	});
}

function getLocationString()
{
	return "X:"+formatNumber(Player.getX(),"#0.0")+"  Z:"+formatNumber(Player.getZ(),"#0.0")+"\nY:"+formatNumber(Player.getY(),"#0.0");
}

function showLocation(name,x,y,z)
{
	lllx=x,llly=y,lllz=z;
	currentlocation = name;
	location.showAtLocation(ctx.getWindow().getDecorView(), 17, 0,0);
	locationstate = 1;
}

function hideLocation()
{
	location.dismiss();
	locationstate = 0;
}

function lockMap(bool)
{
	dismissMap();
	if(isLock||!bool)
	{
		isLock=false;
	}
	else
	{
		isLock=true;
		clientMessage("小地图菜单关闭并锁定");
	}
	map.setTouchable(!bool);
	showMap();
}

function showMap()
{
	map.showAtLocation(ctx.getWindow().getDecorView(), 53, 5*dp, 54*dp);
	isMapShowing=true;
}

function dismissMap()
{
	map.dismiss();
	isMapShowing=false;
}

function showMenu()
{
	dismissMap();
	menupop.showAtLocation(ctx.getWindow().getDecorView(), 17, 0,0);
}

function buildLargeMap(larged)
{
	bt_largemap.setEnabled(false);
	largemaploc.setText("");
	largemaptv.setText("正在加载...0%");
	showLargeMap();
	drawLargeMap(parseInt(Player.getX()),parseInt(Player.getY()),parseInt(Player.getZ()),larged);
}

function showLargeMap()
{
	dismissMap();
	largemaprestore.dismiss();
	largemap.showAtLocation(ctx.getWindow().getDecorView(), 17, 0, 0);
}

function hideLargeMap()
{
	showMap();
	largemap.dismiss();
	largemaprestore.showAtLocation(ctx.getWindow().getDecorView(), 53, 54*dp, 2*dp);
}

function closeLargeMap()
{
	largemaptv.setVisibility(0);
	largemapiv.setVisibility(8);
	bt_largemapclose.setEnabled(false);
	bt_largemapsave.setEnabled(false);
	showMap();
	largemap.dismiss();
}

function startDrawMap()
{
	var mapthread = new java.lang.Thread(new java.lang.Runnable()
	{
		run:function()
		{
			drawMap(parseInt(Player.getX()),parseInt(Player.getY()),parseInt(Player.getZ()));
		}
	});
	if(isPriority)
	{
		mapthread.setPriority(10);
	}
	mapthread.start();
}

function drawMap(x,y,z)
{
	bmp = android.graphics.Bitmap.createBitmap((r*2+1)*pix,(r*2+1)*pix,android.graphics.Bitmap.Config.ARGB_8888);
	canvas = new android.graphics.Canvas(bmp);
	var dx=x-r,dz=z-r-1;
	for(var cdz=0;cdz<=r*2+1;cdz++)
	{
		for(var cdx=0;cdx<=r*2+1;cdx++)
		{
			switch(drawMode)
			{
				case 0:
					paintColor(dx+cdx,dz+cdz,p);
					break;
				case 1:
					paintRadar(dx+cdx,y,dz+cdz,p);
					break;
			}
			canvas.drawRect(cdx*pix,cdz*pix,cdx*pix+pix,cdz*pix+pix,p);
		}
	}
	bitmaptemp = new android.graphics.drawable.BitmapDrawable(bmp);
	
	if(isDraw)
	{
		ctx.runOnUiThread(new java.lang.Runnable()
		{
			run:function()
			{
				mapiv.setBackgroundDrawable(bitmaptemp);
			}
		});
		drawMap(parseInt(Player.getX()),parseInt(Player.getY()),parseInt(Player.getZ()));
	}
}

function drawLargeMap(x,y,z,larged)
{
	var largemapthread = new java.lang.Thread(new java.lang.Runnable()
	{
		run:function()
		{
			lbmp = android.graphics.Bitmap.createBitmap((larged)*pix,(larged)*pix,android.graphics.Bitmap.Config.ARGB_8888);
			lcanvas = new android.graphics.Canvas(lbmp);
			lbmpp = new android.graphics.Paint();
			var ldx=x-(larged/2),ldz=z-(larged/2);
			for(var lcdz=0;lcdz<=larged;lcdz++)
			{
				for(var lcdx=0;lcdx<=larged;lcdx++)
				{
					switch(drawMode)
					{
						case 0:
							paintColor(ldx+lcdx,ldz+lcdz,lbmpp);
							break;
						case 1:
							paintRadar(ldx+lcdx,y,ldz+lcdz,lbmpp);
							break;
					}
					lcanvas.drawRect(lcdx*pix,lcdz*pix,lcdx*pix+pix,lcdz*pix+pix,lbmpp);
				}
				ctx.runOnUiThread(new java.lang.Runnable()
				{
					run:function()
					{
						largemaptv.setText("正在加载..."+formatNumber(lcdz*100/(larged),"#0.0")+"%");
					}
				});
			}	
			ctx.runOnUiThread(new java.lang.Runnable()
			{
				run:function()
				{
					bt_largemap.setEnabled(true);
					largemaptv.setVisibility(8);
					largemapiv.setVisibility(0);
					largemapiv.setImageBitmap(lbmp);
					largemaploc.setText(getLocationString()+"  L:"+larged);
					bt_largemapclose.setEnabled(true);
					bt_largemapsave.setEnabled(true);
				}
			});
		}
	});
	largemapthread.setPriority(10);
	largemapthread.start();
}

function paintColor(x,z,p)
{
	var y=127,b=0,id=0,tdb=0,db=0;
	while(b==0&isDraw)
	{
		b = getTile(x,y,z)
		y-=jump;
	}
	for(var yy=y+jump;b!=0&isDraw;yy++)
	{
		id = b;
		db = tdb;
		b = getTile(x,yy,z);
		tdb = Level.getData(x,yy,z);
	}
	
	if(id==2||id==253)//草方块
		{p.setColor(RGB(117,176,73));}
	else if(id==6||id==31||id==83)//树苗，草，甘蔗
		{p.setColor(RGB(104,156,53));}
	else if(id==175)
	{
		if(db==8&isDraw)
		{
			db=Level.getData(x,yy-3,z);
		}
		if(db==2||db==3)//高草
			{p.setColor(RGB(104,156,53));}
		else//两格的花
			{p.setColor(RGB(255,0,0));}
	}
	else if(id==59||id==141||id==142)//小麦，胡萝卜，马铃薯
		{p.setColor(RGB(146,195,0));}
	else if(id==3)//泥土
		{p.setColor(RGB(134,96,67));}
	else if(id==60)//耕地
		{p.setColor(RGB(95,58,30));}
	else if(id==8||id==9)//水
		{p.setColor(RGB(38,93,255));}
	else if(id==79)//冰
		{p.setColor(RGB(143,173,223));}
	else if(id==10||id==11||id==51)//岩浆，火
		{p.setColor(RGB(252,87,0));}
	else if(id==50||id==89)//火把，萤石
		{p.setColor(RGB(245,220,50));}
	else if(id==12||id==24||id==128)//沙，沙石
		{p.setColor(RGB(218,210,158));}
	else if(id==17)//原木
		{p.setColor(RGB(106,85,52));}
	else if(id==18||id==81||id==106||id==161||id==254)//树叶，仙人掌
		{p.setColor(RGB(41,141,41));}
	else if(id==78||id==80)//雪
		{p.setColor(RGB(230,230,230));}
	else if(id==32)//枯木
		{p.setColor(RGB(148,100,40));}
	else if(id==37)//黄花
		{p.setColor(RGB(255,255,0));}
	else if(id==38||id==73||id==74)//其他花 红石
		{p.setColor(RGB(255,0,0));}
	else if(id==5||id==43||id==53||id==63||id==64||id==85||id==96||id==107||id==125||id==126||id==134||id==135||id==136||id==146||id==158||id==163||id==164)//木板，楼梯，各种木质品
		{p.setColor(RGB(157,128,79));}
	else if(id==1||id==4||id==13||id==48||id==67||id==97||id==98||id==109||id==139||id==255)//石，各种石制品
		{p.setColor(RGB(120,120,120));}
	else if(id==14||id==41)//金
		{p.setColor(RGB(255,255,45));}
	else if(id==15||id==42)//铁
		{p.setColor(RGB(210,210,210));}
	else if(id==16||id==173)//煤
		{p.setColor(RGB(5,5,5));}
	else if(id==56||id==57)//钻石
		{p.setColor(RGB(100,255,255));}
	else if(id==21||id==22)//青金石
		{p.setColor(RGB(10,10,255));}
	else if(id==129||id==133)//绿宝石
		{p.setColor(RGB(50,255,50));}
	else//其他
		{p.setARGB(255,0,0,0);}
		
	return p;
}


function paintRadar(x,y,z,p)
{
	var deepLevel = 0;
	for(var i = y+5;i >= y - 5&isDraw;i--)
	{
		if(getTile(x,i,z)==0)
		{
			deepLevel++;
		}
	}
	p.setColor(RGB(10,220-(deepLevel*20),0));
	return p;
}

/*
Beta 1.4
2015-1-20 11:34
690935161 寒风丶冷叶
*/
